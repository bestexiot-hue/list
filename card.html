
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>カード登録</title>
  <link rel="stylesheet" href="./assets/css/styles.css">
  <style>
    /* --- ページ内補助スタイル（最低限） --- */
    .form-row { display: grid; gap: .5rem; max-width: 640px; margin-bottom: 1rem; }
    .actions  { display: flex; gap: .75rem; }
    .preview  { max-width: 320px; max-height: 240px; border: 1px solid #e5e7eb; border-radius: 8px; object-fit: contain; background: #fff; }
    label > span { font-weight: 600; }
    input[type="text"], input[type="file"], textarea {
      padding: .5rem .75rem; border: 1px solid #cbd5e1; border-radius: 8px; width: 100%;
    }
    .status { margin-top: 1rem; color: #1f2937; }
    .error  { color: #b91c1c; }
    .success{ color: #166534; }

    /* 直近カード表示用 */
    #recent-card-content img {
      width: 220px; height: 155px; object-fit: contain;
      border: 1px solid #e5e7eb; border-radius: 8px; background: #fff;
    }

    /* 保存済み一覧（任意） */
    .cards-section { margin-top: 2rem; }
    .cards-grid {
      display: grid; gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    .card-item {
      border: 1px solid #e5e7eb; border-radius: 12px; background: #fff;
      padding: 0.75rem; display: flex; gap: .75rem;
      box-shadow: 0 4px 14px rgba(0,0,0,0.06);
    }
    .card-item img {
      width: 200px; height: 140px; object-fit: contain;
      border: 1px solid #e5e7eb; border-radius: 8px; background: #fff;
    }
    .card-actions { margin-top: .5rem; display: flex; gap: .5rem; }
    .card-actions .btn-del, .card-actions .btn-dl {
      appearance: none; border: 1px solid #cbd5e1; background: #f8fafc; color: #111827;
      border-radius: 8px; padding: .35rem .6rem; cursor: pointer; text-decoration: none;
    }
    .card-actions .btn-del:hover, .card-actions .btn-dl:hover {
      background: #eef2ff; border-color: #94a3b8;
    }
  </style>
</head>
<body>
  <header class="site-header" role="banner">
    <h1 class="site-title">カード登録</h1>
  </header>

  <main id="main" class="container" role="main">
    <!-- 入力フォーム -->
    <form id="cardForm" novalidate>
      <div class="form-row">
        <label for="cardName"><span>カード名 <sup style="color:#b91c1c;">*</sup></span></label>
        <input type="text" id="cardName" name="card_name" required placeholder="例：メンバーズカード" />
      </div>

      <div class="form-row">
        <label for="cardImage"><span>カード画像（JPEG/PNG）<sup style="color:#b91c1c;">*</sup></span></label>
        <input type="file" id="cardImage" name="card_image" accept="image/*" required />
        <img id="preview" class="preview" alt="画像プレビュー" />
      </div>

      <div class="actions">
        <button type="submit" class="menu-button" style="min-height:44px;">登録する</button>
        <a href="./index.html">メニューに戻る</a>
      </div>

      <div id="status" class="status" role="status" aria-live="polite"></div>
    </form>

    <!-- ① 直近の登録カード表示コンテナ（新規追加） -->
    <section id="recent-card" aria-labelledby="recent-card-title" style="margin-top:1.25rem;">
      <h2 id="recent-card-title" style="margin:0 0 .5rem;">直近の登録カード</h2>
      <div id="recent-card-content" style="display:flex; align-items:flex-start; gap:.75rem;">
        <p style="color:#6b7280;">まだ表示できるカードはありません。</p>
      </div>
    </section>

    <!-- （任意）保存済みカード一覧 -->
    <section id="card-list" class="cards-section" aria-labelledby="cards-title">
      <h2 id="cards-title" style="margin:0 0 .75rem;">保存済みカード一覧</h2>
      <div class="cards-grid" id="cards-grid"></div>
      <p id="cards-empty" style="color:#6b7280; display:none;">まだ保存されたカードはありません。</p>
    </section>
  </main>

  <footer class="site-footer" role="contentinfo">
    <small>&copy; 2025</small>
  </footer>

  <!-- ② ③ を含むスクリプト：IndexedDB保存＋直近描画＋一覧 -->
  <script>
    /* ===== IndexedDB ユーティリティ ===== */
    const DB_NAME = 'cards-db';
    const STORE_NAME = 'cards';

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            store.createIndex('byName', 'name', { unique: false });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function saveCard(name, file) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const record = {
          name,
          filename: file.name,
          mime: file.type || 'image/jpeg',
          imageBlob: file,               // Blobのまま保存（劣化なし）
          createdAt: new Date().toISOString()
        };
        const req = store.add(record);
        req.onsuccess = () => resolve(req.result);  // id が返る
        req.onerror = () => reject(req.error);
      });
    }

    async function listCards() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function deleteCard(id) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const req = store.delete(id);
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
      });
    }

    /* ===== ② id指定で取得 ＆ 直近表示（新規追加） ===== */
    async function getCardById(id) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const req = store.get(id);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function renderRecentCard(cardRecord) {
      const wrap = document.getElementById('recent-card-content');
      if (!wrap || !cardRecord) return;

      // BlobをURLへ（必要に応じて revoke も可能）
      const imgURL = URL.createObjectURL(cardRecord.imageBlob);

      wrap.innerHTML = `
        ${imgURL}
        <div>
          <div style="font-weight:600; color:#111827; font-size:1rem;">${cardRecord.name}</div>
          <div style="color:#6b7280; font-size:.9rem;">${cardRecord.filename} / ${cardRecord.mime}</div>
          <div style="color:#6b7280; font-size:.85rem; margin-top:.25rem;">${cardRecord.createdAt}</div>
          <div style="margin-top:.5rem; display:flex; gap:.5rem;">
            <a href="${imgURL} ">画像をダウンロード</a>
          </div>
        </div>
      `;

      // 表示位置までスクロール（任意）
      document.getElementById('recent-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    /* ===== 保存済み一覧（任意） ===== */
    async function renderList() {
      const grid = document.getElementById('cards-grid');
      const empty = document.getElementById('cards-empty');
      grid.innerHTML = '';
      empty.style.display = 'none';

      let cards = await listCards();
      if (!cards.length) {
        empty.style.display = 'block';
        return;
      }
      // 新しい順に並べる
      cards.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      for (const c of cards) {
        const imgURL = URL.createObjectURL(c.imageBlob);
        const item = document.createElement('article');
        item.className = 'card-item';
        item.innerHTML = `
          ${imgURL}
          <div>
            <div><strong>${c.name}</strong></div>
            <div style="color:#6b7280; font-size:.9rem;">${c.filename} / ${c.mime}</div>
            <div style="color:#6b7280; font-size:.8rem;">${c.createdAt}</div>
            <div class="card-actions">
              <button data-id="${c.id}" class="btn-del">削除</button>
              <a href="${imgURL}">画像DL</a>
            </div>
          </div>
        `;
        grid.appendChild(item);
      }

      // 削除ボタン
      grid.querySelectorAll('.btn-del').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = Number(btn.getAttribute('data-id'));
          await deleteCard(id);
          renderList();
        });
      });
    }

    /* ===== ③ 送信処理の拡張（保存後に直近カードを表示） ===== */
    const form   = document.getElementById('cardForm');
    const nameEl = document.getElementById('cardName');
    const imgEl  = document.getElementById('cardImage');
    const status = document.getElementById('status');
    const preview= document.getElementById('preview');

    imgEl.addEventListener('change', () => {
      const f = imgEl.files[0];
      if (f) preview.src = URL.createObjectURL(f);
      else preview.removeAttribute('src');
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      status.className = 'status'; status.textContent = '';
      const name = nameEl.value.trim();
      const file = imgEl.files[0];

      if (!name || !file) {
        status.classList.add('error');
        status.textContent = 'カード名と画像は必須です。';
        return;
      }

      try {
        const id = await saveCard(name, file);

        // ★ 直近登録カードを取得して表示（新規追加）
        const saved = await getCardById(id);
        renderRecentCard(saved);

        status.classList.add('success');
        status.textContent = `保存しました（ID: ${id}）。`;

        // フォームをリセット（プレビューも消す）
        form.reset();
        preview.removeAttribute('src');

        // （任意）一覧も更新
        renderList();
      } catch (err) {
        console.error(err);
        status.classList.add('error');
        status.textContent = `保存エラー: ${err.message}`;
      }
    });

    // 初期表示（ページ読み込み時）
    renderList();
  </script>
</body>
</html>
