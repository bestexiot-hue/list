
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>カード登録</title>
  <link rel="stylesheet" href="./assets/css/styles.css">
  <style>
    .thumb { width: 64px; height: 64px; object-fit: cover; border-radius: 8px; }
    .row { display:flex; align-items:center; gap:0.75rem; }
    .card-box { background: var(--card); padding:1rem; border-radius:12px; }
  </style>
</head>
<body>
  <header class="site-header">
    <h1 class="site-title">カード登録</h1>
    <nav><a href="./index.html">メニューに戻る</a></nav>
  </header>

  <main class="container">
    <section class="card-box">
      <h2>カード登録フォーム</h2>
      <form id="cardForm">
        <label>
          カード名 <span aria-hidden="true">*</span><br />
          <input type="text" id="cardName" required placeholder="カード名" />
        </label>
        <br /><br />
        <label>
          カード画像（JPEG/PNG・任意）<br />
          <input type="file" id="cardImage" accept="image/png,image/jpeg" />
        </label>

        <div id="imagePreview" style="margin-top:0.75rem;"></div>

        <br />
        <button type="submit" class="menu-button">登録する</button>
      </form>
      <p style="color:var(--muted)">※ 画像は保存前に長辺 800px・JPEG 品質 0.8 へ圧縮します。</p>
    </section>

    <section>
      <h3>直近の登録カード</h3>
      <ul id="recentCards" class="menu-list"></ul>

      <h3>保存済みカード一覧</h3>
      <ul id="savedCards" class="menu-list"></ul>
    </section>
  </main>

  <footer class="site-footer"><small>© 2025</small></footer>

  <script>
    const LS_KEYS = { cards: 'cards' };

    // ---- Storage helpers ----
    function getCardsRaw() {
      try { return JSON.parse(localStorage.getItem(LS_KEYS.cards)) || []; }
      catch { return []; }
    }
    function setCards(cards) {
      localStorage.setItem(LS_KEYS.cards, JSON.stringify(cards));
    }

    // 旧データ（string配列）→ 新形式へ移行
    function migrateCardsIfNeeded() {
      const raw = getCardsRaw();
      if (raw.length && typeof raw[0] === 'string') {
        const migrated = raw.map(name => ({
          id: cryptoRandomId(),
          name, image: null, createdAt: Date.now()
        }));
        setCards(migrated);
        return migrated;
      }
      return raw;
    }

    function getCards() { return migrateCardsIfNeeded(); }

    // ---- utils ----
    function cryptoRandomId() {
      // 簡易ID（UUID風）
      return 'c_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    async function fileToCompressedDataURL(file, maxSide = 800, quality = 0.8) {
      if (!file) return null;
      // type チェック
      if (!/^image\\/(png|jpeg)$/.test(file.type)) {
        alert('PNG/JPEG の画像を選択してください');
        return null;
      }

      const blobURL = URL.createObjectURL(file);
      const img = new Image();
      img.src = blobURL;
      await img.decode().catch(() => { /* Safari対策 */ });

      const { width, height } = img;
      const scale = Math.min(1, maxSide / Math.max(width, height));
      const w = Math.round(width * scale);
      const h = Math.round(height * scale);

      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);

      URL.revokeObjectURL(blobURL);
      return canvas.toDataURL('image/jpeg', quality); // PNGでもJPEG保存
    }

    // ---- renderers ----
    function renderCards() {
      const cards = getCards();
      const recent = document.getElementById('recentCards');
      const saved = document.getElementById('savedCards');
      recent.innerHTML = ''; saved.innerHTML = '';

      // 直近5件（新しい順）
      [...cards].sort((a,b)=>b.createdAt-a.createdAt).slice(0,5).forEach(card => {
        const li = document.createElement('li');
        li.className = 'menu-item row';
        if (card.image) {
          const img = document.createElement('img');
          img.className = 'thumb'; img.src = card.image; img.alt = card.name;
          li.appendChild(img);
        }
        const span = document.createElement('span');
        span.textContent = card.name;
        li.appendChild(span);
        recent.appendChild(li);
      });

      // 全件（登録順）
      cards.forEach(card => {
        const li = document.createElement('li');
        li.className = 'menu-item row';
        if (card.image) {
          const img = document.createElement('img');
          img.className = 'thumb'; img.src = card.image; img.alt = card.name;
          li.appendChild(img);
        }
        const span = document.createElement('span');
        span.textContent = card.name;
        li.appendChild(span);
        saved.appendChild(li);
      });
    }

    // ---- preview ----
    document.getElementById('cardImage').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      const preview = document.getElementById('imagePreview');
      preview.innerHTML = '';
      if (!file) return;
      const dataURL = await fileToCompressedDataURL(file, 256, 0.8); // プレビュー用は小さめ
      if (dataURL) {
        const img = document.createElement('img');
        img.className = 'thumb';
        img.src = dataURL;
        img.alt = 'プレビュー';
        preview.appendChild(img);
      }
    });

    // ---- form submit ----
    document.getElementById('cardForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('cardName').value.trim();
      const file = document.getElementById('cardImage').files?.[0] || null;

      if (!name) { alert('カード名を入力してください'); return; }

      const cards = getCards();
      if (cards.some(c => c.name === name)) {
        alert('同じカード名が既に存在します');
        return;
      }

      const imageDataURL = file ? await fileToCompressedDataURL(file, 800, 0.8) : null;
      const newCard = { id: cryptoRandomId(), name, image: imageDataURL, createdAt: Date.now() };

      cards.push(newCard);
      setCards(cards);

      document.getElementById('cardForm').reset();
      document.getElementById('imagePreview').innerHTML = '';
      renderCards();
      alert('カードを登録しました');
    });

    // 初期表示
    renderCards();
  </script>
</body>
</html>
